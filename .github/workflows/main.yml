name: Persistent VPS with Account Backup
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 355
    steps:
      - name: Setup Persistent VPS with Account Backup
        run: |
          # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
          BACKUP_FILE="/tmp/vps_accounts.backup"
          CONFIG_DIR="/tmp/vps_config"
          LOG_FILE="/tmp/vps_connection.log"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙƒÙˆÙŠÙ†
          mkdir -p $CONFIG_DIR
          
          # Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
          backup_accounts() {
            echo "ğŸ’¾ Backing up account information..."
            TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
            
            # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            {
              echo "=== VPS ACCOUNT BACKUP - $TIMESTAMP ==="
              echo "VPS_ID: vps-${{ github.run_id }}"
              echo "CREATED_AT: $(date)"
              echo "GITHUB_RUN_ID: ${{ github.run_id }}"
              echo "TAILSCALE_AUTH: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}"
              
              # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª SSH
              echo "SSH_ROOT_PASSWORD: admin@123"
              echo "SSH_PORT: 22"
              
              # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
              echo "PUBLIC_IP: $(curl -s ifconfig.me || echo 'N/A')"
              echo "TAILSCALE_IP: $(tailscale ip -4 2>/dev/null || echo 'NOT_CONNECTED')"
              echo "HOSTNAME: $(hostname)"
              
              # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              echo "OS: $(lsb_release -d | cut -f2)"
              echo "KERNEL: $(uname -r)"
              echo "UPTIME: $(uptime -p)"
              
              # Ø®Ø¯Ù…Ø§Øª Ù†Ø´Ø·Ø©
              echo "ACTIVE_SERVICES:"
              systemctl list-units --type=service --state=running | grep -E "(ssh|tailscale)" | awk '{print "  - " $1}'
              
              echo "=== END BACKUP ==="
            } > "$BACKUP_FILE.$TIMESTAMP"
            
            # Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ø§Ø¦Ù…
            cp "$BACKUP_FILE.$TIMESTAMP" "$BACKUP_FILE"
            cp "$BACKUP_FILE" "$CONFIG_DIR/vps_accounts.current"
            
            echo "âœ… Accounts backed up to: $BACKUP_FILE"
          }

          # Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
          restore_accounts() {
            if [ -f "$BACKUP_FILE" ]; then
              echo "ğŸ”„ Restoring previous account information..."
              echo "=== PREVIOUS SESSION INFO ==="
              cat "$BACKUP_FILE"
              echo "=== END PREVIOUS INFO ==="
              
              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
              PREVIOUS_TS_IP=$(grep "TAILSCALE_IP:" "$BACKUP_FILE" | cut -d':' -f2- | tr -d ' ')
              PREVIOUS_VPS_ID=$(grep "VPS_ID:" "$BACKUP_FILE" | cut -d':' -f2- | tr -d ' ')
              
              echo "ğŸ”— Previous Tailscale IP: $PREVIOUS_TS_IP"
              echo "ğŸ†” Previous VPS ID: $PREVIOUS_VPS_ID"
            else
              echo "ğŸ“ No previous backup found - fresh start"
            fi
          }

          # Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          save_connection_info() {
            echo "ğŸ“ Saving current connection info..."
            CURRENT_TS_IP=$(tailscale ip -4 2>/dev/null || echo "DISCONNECTED")
            CURRENT_TS_STATUS=$(tailscale status --json 2>/dev/null | jq -r '.BackendState' 2>/dev/null || echo "OFFLINE")
            
            {
              echo "=== CURRENT CONNECTION STATUS ==="
              echo "TIMESTAMP: $(date)"
              echo "TAILSCALE_IP: $CURRENT_TS_IP"
              echo "TAILSCALE_STATUS: $CURRENT_TS_STATUS"
              echo "SSH_STATUS: $(systemctl is-active ssh)"
              echo "PUBLIC_IP: $(curl -s ifconfig.me || echo 'N/A')"
              echo "=== END CURRENT STATUS ==="
            } > "$CONFIG_DIR/connection_status.txt"
          }

          # Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø§ØªØµØ§Ù„
          log_connection_event() {
            EVENT=$1
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] $EVENT" >> "$LOG_FILE"
          }

          # Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
          display_account_info() {
            echo ""
            echo "ğŸ” ================================="
            echo "ğŸ” VPS ACCOUNT INFORMATION"
            echo "ğŸ” ================================="
            echo "ğŸ‘¤ SSH Username: root"
            echo "ğŸ”‘ SSH Password: admin@123"
            echo "ğŸ”— SSH Command: ssh root@$(tailscale ip -4 2>/dev/null || echo 'TAILSCALE_IP')"
            echo "ğŸŒ Tailscale IP: $(tailscale ip -4 2>/dev/null || echo 'Connecting...')"
            echo "ğŸ“¡ Public IP: $(curl -s ifconfig.me || echo 'N/A')"
            echo "ğŸ†” VPS ID: vps-${{ github.run_id }}"
            echo "â° Started: $(date)"
            echo "ğŸ’¾ Backup: $BACKUP_FILE"
            echo "ğŸ” ================================="
            echo ""
          }

          # Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ
          initial_setup() {
            echo "âš™ï¸ Performing initial VPS setup..."
            
            # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            restore_accounts
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…
            sudo apt update -y
            sudo apt install -y openssh-server curl jq
            
            # ØªÙƒÙˆÙŠÙ† SSH
            echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
            echo "PasswordAuthentication yes" | sudo tee -a /etc/ssh/sshd_config
            echo "root:admin@123" | sudo chpasswd
            sudo systemctl enable ssh
            sudo systemctl start ssh
            
            # ØªØ«Ø¨ÙŠØª ÙˆØªÙƒÙˆÙŠÙ† Tailscale
            curl -fsSL https://tailscale.com/install.sh | sh
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=persistent-vps-${{ github.run_id }} --accept-dns=false
            
            # Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            backup_accounts
            save_connection_info
            display_account_info
            
            log_connection_event "VPS_INITIALIZED"
          }

          # Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø°ÙƒÙŠ
          reconnect_services() {
            echo "ğŸ”„ Attempting to reconnect services..."
            
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ SSH Ø¥Ø°Ø§ ØªÙˆÙ‚Ù
            if ! sudo systemctl is-active --quiet ssh; then
              echo "ğŸ”§ Restarting SSH service..."
              sudo systemctl restart ssh
              log_connection_event "SSH_RESTARTED"
            fi
            
            # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Tailscale
            TS_STATUS=$(tailscale status --json 2>/dev/null | jq -r '.BackendState' 2>/dev/null || echo "disconnected")
            if [ "$TS_STATUS" != "Running" ]; then
              echo "ğŸ”— Reconnecting Tailscale..."
              sudo tailscale up --reset --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --accept-dns=false
              log_connection_event "TAILSCALE_RECONNECTED"
            fi
            
            # ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
            backup_accounts
            save_connection_info
          }

          # Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          show_stats() {
            echo "ğŸ“Š Connection Statistics:"
            echo "â° Uptime: $(uptime -p)"
            echo "ğŸ”— Reconnect attempts: $(grep -c "RECONNECT" $LOG_FILE 2>/dev/null || echo 0)"
            echo "ğŸ“ Log entries: $(wc -l < $LOG_FILE 2>/dev/null || echo 0)"
            echo "ğŸ’¾ Backup files: $(ls -1 $CONFIG_DIR/*.backup 2>/dev/null | wc -l || echo 0)"
          }

          # Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          echo "ğŸš€ Starting Persistent VPS with Account Backup..."
          initial_setup

          # Loop Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          SESSION_START=$SECONDS
          MAX_DURATION=21000  # 350 Ø¯Ù‚ÙŠÙ‚Ø©
          CHECK_INTERVAL=300  # 5 Ø¯Ù‚Ø§Ø¦Ù‚
          CONSECUTIVE_FAILURES=0
          MAX_CONSECUTIVE_FAILURES=3

          while [ $((SECONDS - SESSION_START)) -lt $MAX_DURATION ]; do
            CURRENT_TIME=$SECONDS
            ELAPSED_MINUTES=$(( (CURRENT_TIME - SESSION_START) / 60 ))
            REMAINING_MINUTES=$(( (MAX_DURATION - (CURRENT_TIME - SESSION_START)) / 60 ))
            
            echo ""
            echo "=========================================="
            echo "ğŸ• Elapsed: ${ELAPSED_MINUTES}m | Remaining: ${REMAINING_MINUTES}m"
            echo "=========================================="
            
            # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            display_account_info
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª
            SSH_ACTIVE=$(sudo systemctl is-active ssh)
            TAILSCALE_ACTIVE=$(tailscale status --json 2>/dev/null | jq -r '.BackendState' 2>/dev/null)
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "DISCONNECTED")
            
            echo "ğŸ” Service Status:"
            echo "  ğŸ”Œ SSH: $SSH_ACTIVE"
            echo "  ğŸŒ Tailscale: $TAILSCALE_ACTIVE"
            echo "  ğŸ“¡ Tailscale IP: $TAILSCALE_IP"
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            if [ "$SSH_ACTIVE" != "active" ] || [ "$TAILSCALE_ACTIVE" != "Running" ]; then
              echo "âš ï¸ Service issues detected!"
              CONSECUTIVE_FAILURES=$((CONSECUTIVE_FAILURES + 1))
              log_connection_event "SERVICE_ISSUE_DETECTED_FAILURE_$CONSECUTIVE_FAILURES"
              
              if [ $CONSECUTIVE_FAILURES -ge $MAX_CONSECUTIVE_FAILURES ]; then
                echo "ğŸš¨ Critical failure - performing emergency recovery..."
                reconnect_services
                CONSECUTIVE_FAILURES=0
                log_connection_event "EMERGENCY_RECOVERY_EXECUTED"
              else
                echo "ğŸ”§ Attempting service recovery..."
                reconnect_services
              fi
            else
              if [ $CONSECUTIVE_FAILURES -gt 0 ]; then
                echo "âœ… Services restored to normal"
                CONSECUTIVE_FAILURES=0
                log_connection_event "SERVICES_RECOVERED"
              fi
            fi
            
            # Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯ÙˆØ±ÙŠØ©
            if [ $((ELAPSED_MINUTES % 30)) -eq 0 ]; then  # ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
              backup_accounts
              echo "ğŸ’¾ Periodic backup completed"
            fi
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            show_stats
            
            echo "ğŸ’¤ Next check in 5 minutes..."
            sleep $CHECK_INTERVAL
          done

          # Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
          echo "ğŸ¯ Session completed - saving final state..."
          backup_accounts
          save_connection_info
          log_connection_event "SESSION_COMPLETED_SUCCESSFULLY"
          
          echo ""
          echo "âœ… ================================="
          echo "âœ… VPS Session Completed Successfully"
          echo "âœ… ================================="
          echo "ğŸ“Š Final Statistics:"
          show_stats
          echo "ğŸ” Next auto-reconnect in 6 hours"
          echo "ğŸ’¾ Account info saved in: $CONFIG_DIR"

      - name: Upload Account Backup
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vps-accounts-backup
          path: |
            /tmp/vps_accounts.backup
            /tmp/vps_config/
          retention-days: 30

      - name: Display Final Connection Info
        if: always()
        run: |
          echo "ğŸ” FINAL CONNECTION INFORMATION:"
          echo "================================="
          if [ -f "/tmp/vps_accounts.backup" ]; then
            cat "/tmp/vps_accounts.backup"
          else
            echo "No backup file found - session may have failed early"
          fi
